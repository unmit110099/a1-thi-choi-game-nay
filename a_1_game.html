<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Game A1 — Chúc mừng!</title>
  <style>
    html,body{height:100%;margin:0;background:linear-gradient(#74d4ff,#b3ecff);font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    #gameWrap{display:flex;align-items:center;justify-content:center;height:100%}
    canvas{background:transparent;border-radius:16px;box-shadow:0 8px 26px rgba(0,0,0,0.15)}
    #overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
    .endCard{pointer-events:auto;min-width:260px;max-width:92%;padding:18px;border-radius:14px;background:linear-gradient(180deg,#fff,#f9fbff);box-shadow:0 10px 40px rgba(2,6,23,0.2);text-align:center}
    .endCard h1{font-size:18px;margin:6px 0}
    .endCard p{font-size:15px;margin:8px 0;color:#333}
    .btn{display:inline-block;margin-top:12px;padding:8px 14px;border-radius:10px;background:#3b82f6;color:#fff;text-decoration:none;cursor:pointer}
    .topBar,.timer{position:absolute;top:14px;font-weight:700;background:rgba(255,255,255,0.7);padding:8px 12px;border-radius:10px;backdrop-filter:blur(8px)}
    .topBar{left:14px}
    .timer{right:14px}
    @media (max-width:480px){canvas{width:100vw;height:75vh}}
  </style>
</head>
<body>
  <div id="gameWrap">
    <div style="position:relative">
      <canvas id="c"></canvas>
      <div class="topBar" id="score">Điểm: 0</div>
      <div class="timer" id="timer">19.0s</div>
    </div>
  </div>

  <div id="overlay"></div>

  <script>
  const DURATION = 19.0;
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  let W,H;

  function resize(){
    const ratio = window.devicePixelRatio || 1;
    const maxW = window.innerWidth;
    const maxH = window.innerHeight * 0.75;
    canvas.style.width = maxW + 'px';
    canvas.style.height = maxH + 'px';
    W = canvas.width = Math.floor(maxW * ratio);
    H = canvas.height = Math.floor(maxH * ratio);
    ctx.setTransform(ratio,0,0,ratio,0,0);
  }
  window.addEventListener('resize', resize);
  resize();

  const player={x:150,y:0,w:80};
  player.y = H - 120;

  let score = 0;
  const items=[];
  const particles=[];
  let spawnTimer=0;
  let last = performance.now();
  let elapsed = 0;
  let running = true;

  function resetGame(){
    score=0; elapsed=0; running=true;
    items.length=0; particles.length=0;
    document.getElementById('score').textContent='Điểm: 0';
    document.getElementById('overlay').innerHTML='';
    last=performance.now();
    requestAnimationFrame(loop);
  }

  function spawnItem(){
    const size = 45 + Math.random()*30;
    items.push({x:40+Math.random()*(W-80),y:-60,vy:1.6+Math.random()*2.2,r:size,wob:Math.random()});
  }

  function makeExplosion(x,y,color,amount=22){
    for(let i=0;i<amount;i++){
      const a = Math.random()*Math.PI*2;
      const s = 1 + Math.random()*4;
      particles.push({x,y,ax:Math.cos(a)*s,ay:Math.sin(a)*s,life:45+Math.random()*40,color,size:3+Math.random()*4});
    }
  }

  function collectIfHit(it){
    const dx = it.x - player.x;
    const dy = it.y - player.y;
    return Math.sqrt(dx*dx+dy*dy) < it.r*0.6 + player.w*0.4;
  }

  // mobile-friendly input
  let dragging=false;
  function pointerDown(e){dragging=true;movePointer(e)}
  function pointerUp(){dragging=false}
  function movePointer(e){
    const cx = (e.touches?e.touches[0].clientX:e.clientX);
    const rect = canvas.getBoundingClientRect();
    const x = cx - rect.left;
    player.x = Math.max(40,Math.min(x,rect.width-40));
  }
  canvas.addEventListener('touchstart',pointerDown,{passive:true});
  canvas.addEventListener('touchmove',movePointer,{passive:true});
  canvas.addEventListener('touchend',pointerUp);
  canvas.addEventListener('mousedown',pointerDown);
  window.addEventListener('mousemove',(e)=>{if(dragging)movePointer(e)});
  window.addEventListener('mouseup',pointerUp);

  function drawPanda(ctx,x,y,size){ /* giữ nguyên */ }
  function drawStar(ctx,x,y,r,angle){ /* giữ nguyên */ }
  const bgStars = Array.from({length:40},()=>({x:Math.random()*W,y:Math.random()*H,s:1+Math.random()*2}));

  function update(dt){
    if(!running)return;
    elapsed += dt;
    spawnTimer -= dt;
    if(spawnTimer<=0){spawnTimer=0.3+Math.random()*0.6;spawnItem();}

    for(let i=items.length-1;i>=0;i--){
      const it = items[i]; it.y += it.vy; it.x += Math.sin((it.y+it.wob*10)/40)*1.1;
      if(collectIfHit(it)){score += Math.floor(8 + it.r/7); document.getElementById('score').textContent='Điểm: '+score; makeExplosion(it.x,it.y,'#ffd86b',25); playSoundCollect(); items.splice(i,1); continue;}
      if(it.y>H+80)items.splice(i,1);
    }

    for(let i=particles.length-1;i>=0;i--){
      const p=particles[i]; p.x+=p.ax; p.y+=p.ay; p.ay+=0.12; p.life--; if(p.life<=0)particles.splice(i,1);
    }

    for(const s of bgStars){s.y+=0.4; if(s.y>H) s.y=-4}

    if(elapsed>=DURATION) endGame();
  }

  function draw(){ /* giữ nguyên */ }

  function loop(t){
    const dt=Math.min(0.05,(t-last)/1000); last=t;
    update(dt); draw();
    const rem=Math.max(0,(DURATION-elapsed));
    document.getElementById('timer').textContent=rem.toFixed(1)+'s';
    if(running) requestAnimationFrame(loop);
  }

  let audioCtx,masterGain,isPlaying=false;
  function setupAudio(){audioCtx=new (window.AudioContext||window.webkitAudioContext)(); masterGain=audioCtx.createGain(); masterGain.gain.value=0.2; masterGain.connect(audioCtx.destination);}
  function playSoundCollect(){if(!audioCtx)return; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='triangle'; o.frequency.value=600+Math.random()*200; o.connect(g); g.connect(masterGain); const t=audioCtx.currentTime; g.gain.setValueAtTime(0.001,t); g.gain.exponentialRampToValueAtTime(0.6,t+0.03); g.gain.exponentialRampToValueAtTime(0.001,t+0.15); o.start(t); o.stop(t+0.15);}
  function startMusic(){if(isPlaying)return; isPlaying=true; setupAudio(); const notes=[523,659,784,659,523,392]; let i=0; setInterval(()=>{if(!audioCtx)return; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='sine'; o.frequency.value=notes[i%notes.length]; o.connect(g); g.connect(masterGain); const t=audioCtx.currentTime; g.gain.setValueAtTime(0.001,t); g.gain.exponentialRampToValueAtTime(0.4,t+0.04); g.gain.exponentialRampToValueAtTime(0.001,t+0.25); o.start(t); o.stop(t+0.26); i++;},300);}

  function endGame(){running=false; showEndCard();}

  function showEndCard(){
    const ov=document.getElementById('overlay'); ov.innerHTML='';
    const card=document.createElement('div'); card.className='endCard';
    card.innerHTML=`<h1>Chúc mừng!</h1>
      <p>Chúc anh em A1 luôn vui vẻ, hạnh phúc, nghìn sự như ý, vạn sự như mơ, triệu sự bất ngờ, tỷ lần hạnh phúc. Chị em tôi mãi tự hào về ae A1!!!</p>
      <button class='btn' id='replayBtn'>Chơi lại</button>`;
    ov.appendChild(card);
    document.getElementById('replayBtn').addEventListener('click',()=>{resetGame();});
  }

  startMusic();
  requestAnimationFrame(loop);
  </script>
</body>
</html>
